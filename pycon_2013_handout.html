<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.8" />
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}


#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_part_0_pre_requisites">Part 0 - Pre-requisites</h2>
<div class="sectionbody">
<div class="paragraph"><p>If you haven&#8217;t got the pre-requisites, you&#8217;ll have to follow along with someone
else&#8217;s PC.</p></div>
<div class="ulist"><ul>
<li>
<p>
Git and my repo checked out (<code>git clone https://github.com/hjwp/Test-Driven-Django-Tutorial</code>)
</p>
</li>
<li>
<p>
Firefox
</p>
</li>
<li>
<p>
Python 2.7
</p>
</li>
<li>
<p>
Django 1.4 or 1.5
</p>
</li>
<li>
<p>
Selenium (latest version)
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_testing_you_have_the_pre_requisites_installed">Testing you have the pre-requisites installed</h3>
<div class="sect3">
<h4 id="_git">Git:</h4>
<div class="paragraph"><p>cd to wherever you have my repo checked out</p></div>
<div class="listingblock">
<div class="content">
<pre><code>git checkout pycon_2013
ls pycon_2013_handout.asciidoc</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_django">Django:</h4>
<div class="listingblock">
<div class="content">
<pre><code>cd /tmp #or wherever
django-admin.py startproject delete_me
cd delete_me
python manage.py runserver</code></pre>
</div></div>
<div class="paragraph"><p>And check you can see the Django "It worked" page on <a href="http://localhost:8000">http://localhost:8000</a></p></div>
</div>
<div class="sect3">
<h4 id="_selenium">Selenium</h4>
<div class="paragraph"><p>In a script or a Python shell:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> selenium <span style="font-weight: bold"><span style="color: #000080">import</span></span> webdriver
browser <span style="color: #990000">=</span> webdriver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Firefox</span></span><span style="color: #990000">()</span>
browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://www.google.com'</span><span style="color: #990000">)</span>
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> browser<span style="color: #990000">.</span>title</tt></pre></div></div>
<div class="paragraph"><p>should print &#8220;Google&#8221;</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_1_getting_django_set_up_using_a_selenium_functional_test">Part 1 - Getting Django set up using a Selenium Functional Test</h2>
<div class="sectionbody">
<div class="paragraph"><p>Open a new file called <em>functional_tests.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> selenium <span style="font-weight: bold"><span style="color: #000080">import</span></span> webdriver

browser <span style="color: #990000">=</span> webdriver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Firefox</span></span><span style="color: #990000">()</span>
browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8000'</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">assert</span></span> <span style="color: #FF0000">'Django'</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> browser<span style="color: #990000">.</span>title
<span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #FF0000">'OK!'</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure:  <code>AssertionError</code></p></div>
<div class="paragraph"><p>In a separate console window:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>django-admin.py startproject mysite</code></pre>
</div></div>
<div class="paragraph"><p>Should give you a folder structure like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>mysite
|-- manage.py
`-- mysite
    |-- __init__.py
    |-- settings.py
    |-- urls.py
    `-- wsgi.py</code></pre>
</div></div>
<div class="paragraph"><p>If it doesn&#8217;t, you&#8217;re probably on the wrong version of Django. You&#8217;ll probably
have to switch to someone else&#8217;s PC.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>cd mysite
python manage.py runserver</code></pre>
</div></div>
<div class="paragraph"><p>Expected pass: test prints <em>OK!</em></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">If it doesn&#8217;t work, check the port&#8201;&#8212;&#8201;is <code>runserver</code> using port 8000, or
is it on a different one? 8001?</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Can you make the dev server run on a different port?  And adjust the FT
accordingly?  What about running just at <em>http://localhost/</em>, with no <code>:</code>?</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_2_code_unittest_code_and_looking_for_our_site_8217_s_home_page">Part 2 - <code>unittest</code> and looking for our site&#8217;s home page</h2>
<div class="sectionbody">
<div class="paragraph"><p>We update <em>functional_tests.py</em> to use the <code>unittest</code> module.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> unittest
<span style="font-weight: bold"><span style="color: #000080">from</span></span> selenium <span style="font-weight: bold"><span style="color: #000080">import</span></span> webdriver

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollsFunctionalTest</span></span><span style="color: #990000">(</span>unittest<span style="color: #990000">.</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">setUp</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>browser <span style="color: #990000">=</span> webdriver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Firefox</span></span><span style="color: #990000">()</span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">implicitly_wait</span></span><span style="color: #990000">(</span><span style="color: #993399">3</span><span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">tearDown</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">quit</span></span><span style="color: #990000">()</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_voting_on_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Elspeth goes to check out a cool new polls site she's heard about</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8000'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># It is obviously all about polls:</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Poll'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span>title<span style="color: #990000">)</span>

        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'finish this test'</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> __name__ <span style="color: #990000">==</span> <span style="color: #FF0000">'__main__'</span><span style="color: #990000">:</span>
    unittest<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">main</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Some things to ask me about, in case I don&#8217;t mention them</div>
<div class="ulist"><ul>
<li>
<p>
why is <code>unittest</code> helpful?
</p>
</li>
<li>
<p>
What is <code>assertIn</code>?
</p>
</li>
<li>
<p>
<code>setUp</code>, <code>tearDown</code>
</p>
</li>
<li>
<p>
<code>if __name__ == '__main__'</code>
</p>
</li>
<li>
<p>
<code>self.browser.implicitly_wait()</code>
</p>
</li>
</ul></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: 'Polls' not found in u'Welcome to Django'</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">If you get a message saying &#8220;Problem loading page&#8221; or
&#8220;Unable to connect&#8221;, could it be because the dev server isn&#8217;t running?
Use <code>python manage.py runserver</code> to start it up again&#8230;</td>
</tr></table>
</div>
<div class="paragraph"><p>Finish writing the FT as comments:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_voting_on_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Elspeth goest to check out a cool new polls site she's heard about</span></span>
    self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8000'</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># It is obviously all about polls:</span></span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Poll'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span>title<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># She clicks on the link to the first Poll, which is titled</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># "How awesome is TDD?"</span></span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'finish this test'</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># She is taken to a poll 'results' page, which says</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># "No-one has voted on this poll yet"</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># She also sees a form, which offers her several choices.</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># There are three options with radio buttons</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># She decided to select "very awesome", which is answer #1</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Elspeth clicks 'submit'</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># The page refreshes, and she sees that her choice</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># has updated the results.  They now say</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># "1 vote" and "100 %: very awesome".</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Elspeth decides to try to vote again</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># The site is not very clever (yet) so it lets her</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># She votes for another choice, and the percentages go 50%-50%</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># She votes again, and they go 66% - 33%</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Satisfied, she goes back to sleep</span></span>

<span style="color: #990000">[...]</span>
</tt></pre></div></div>
<div class="paragraph"><p>Finish up by <strong>moving</strong> <em>functional_tests.py</em> into the <em>mysite</em> folder</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Look up some of the other assertion methods in unittest.  Do they all make
sense?  What might you use <em>assertItemsEqual</em> for?</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_3_unit_tests_a_django_app_urls_py_and_views_py">Part 3 - Unit tests, a Django app, urls.py and views.py</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_create_a_polls_app_and_run_its_unit_tests">Create a polls app and run its unit tests</h3>
<div class="paragraph"><p>Run the following command:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>python manage.py startapp polls</code></pre>
</div></div>
<div class="paragraph"><p>Your directory tree will now look like this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>mysite
|-- functional_test.py
|-- manage.py
|-- mysite
|   |-- __init__.py
|   |-- settings.py
|   |-- urls.py
|   `-- wsgi.py
`-- polls
    |-- __init__.py
    |-- models.py
    |-- tests.py
    `-- views.py</code></pre>
</div></div>
<div class="paragraph"><p>Now we deliberately break the unit test at <em>polls/tests.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>test <span style="font-weight: bold"><span style="color: #000080">import</span></span> TestCase

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">SimpleTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_basic_addition</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
<span style="font-style: italic"><span style="color: #9A1900">        """</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        Tests that 1 + 1 always equals 2.</span></span>
<span style="font-style: italic"><span style="color: #9A1900">        """</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span><span style="color: #993399">1</span> <span style="color: #990000">+</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>To run it: <code>python manage.py test</code></p></div>
<div class="paragraph"><p>Expected Failure 1:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>settings.DATABASES is improperly configured.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about: The difference between unit tests and functional tests</td>
</tr></table>
</div>
<div class="paragraph"><p>Fix in <em>mysite/settings.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DATABASES <span style="color: #990000">=</span> <span style="color: #990000">{</span>
    <span style="color: #FF0000">'default'</span><span style="color: #990000">:</span> <span style="color: #990000">{</span>
        <span style="color: #FF0000">'ENGINE'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'django.db.backends.sqlite3'</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">'NAME'</span><span style="color: #990000">:</span> <span style="color: #FF0000">''</span><span style="color: #990000">,</span>               <span style="font-style: italic"><span style="color: #9A1900"># Or path to database file if using sqlite3.</span></span></tt></pre></div></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python manage.py test
$ python manage.py test polls</code></pre>
</div></div>
<div class="paragraph"><p>Expected Failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ImproperlyConfigured: App with label polls could not be found</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about: re-usable apps?</td>
</tr></table>
</div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>INSTALLED_APPS <span style="color: #990000">=</span> <span style="color: #990000">(</span>
    <span style="color: #FF0000">'django.contrib.auth'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.contenttypes'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.sessions'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.sites'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.messages'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.staticfiles'</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable the admin:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 'django.contrib.admin',</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable admin documentation:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 'django.contrib.admindocs',</span></span>
    <span style="color: #FF0000">'polls'</span><span style="color: #990000">,</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: 2 != 3</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_django_url_mapping_in_urls_py">Django url mapping in urls.py</h3>
<div class="paragraph"><p>Now change <em>polls/tests.py</em>, throwing away almost all the old stuff</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>core<span style="color: #990000">.</span>urlresolvers <span style="font-weight: bold"><span style="color: #000080">import</span></span> resolve
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>test <span style="font-weight: bold"><span style="color: #000080">import</span></span> TestCase
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>views <span style="font-weight: bold"><span style="color: #000080">import</span></span> home_page

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">HomePageTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_root_url_resolves_to_home_page_view</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        found <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">resolve</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span>found<span style="color: #990000">.</span>func<span style="color: #990000">,</span> home_page<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ImportError: cannot import name home_page</code></pre>
</div></div>
<div class="paragraph"><p>In <em>polls/views.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Create your views here.</span></span>
home_page <span style="color: #990000">=</span> None</tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">ask me about: that being totally ridiculous!</td>
</tr></table>
</div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>Resolver404: {'path': '', 'tried': []}</code></pre>
</div></div>
<div class="paragraph"><p>In <em>mysite/urls.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>conf<span style="color: #990000">.</span>urls <span style="font-weight: bold"><span style="color: #000080">import</span></span> patterns<span style="color: #990000">,</span> include<span style="color: #990000">,</span> url

<span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next two lines to enable the admin:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># from django.contrib import admin</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># admin.autodiscover()</span></span>

urlpatterns <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">patterns</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Examples:</span></span>
    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^$'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'polls.views.home_page'</span><span style="color: #990000">,</span> name<span style="color: #990000">=</span><span style="color: #FF0000">'home'</span><span style="color: #990000">),</span>
    <span style="font-style: italic"><span style="color: #9A1900"># url(r'^polls/', include('polls.foo.urls')),</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the admin/doc line below to enable admin documentation:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># url(r'^admin/doc/', include('django.contrib.admindocs.urls')),</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable the admin:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># url(r'^admin/', include(admin.site.urls)),</span></span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ViewDoesNotExist: Could not import polls.views.home_page. View is not callable.</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">ask me about: dot-notation vs importing views.</td>
</tr></table>
</div>
<div class="paragraph"><p>So, in <em>polls/views.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Create your views here.</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">():</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="paragraph"><p>Test should pass!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="ulist"><ul>
<li>
<p>
Would a lambda function work? Are there any other Python objects you could
use that would still get the tests to pass?
</p>
</li>
<li>
<p>
What happens when you use the empty string ('') as the URL you call in the
test?  What about two slashes (//)
</p>
</li>
</ul></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_a_minimal_view_to_return_static_html_in_views_py">A minimal view to return static HTML in views.py</h3>
<div class="paragraph"><p>We extend the unit tests in <em>polls/tests.py</em>, to say we want our view
to return some static HTML&#8230;</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>core<span style="color: #990000">.</span>urlresolvers <span style="font-weight: bold"><span style="color: #000080">import</span></span> resolve
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>test <span style="font-weight: bold"><span style="color: #000080">import</span></span> TestCase
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>http <span style="font-weight: bold"><span style="color: #000080">import</span></span> HttpRequest
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>views <span style="font-weight: bold"><span style="color: #000080">import</span></span> home_page

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">HomePageTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_root_url_resolves_to_home_page_view</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        found <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">resolve</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span>found<span style="color: #990000">.</span>func<span style="color: #990000">,</span> home_page<span style="color: #990000">)</span>


    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_home_page_returns_correct_html</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">HttpRequest</span></span><span style="color: #990000">()</span>
        response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTrue</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">startswith</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;html&gt;'</span><span style="color: #990000">))</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;title&gt;Poll ALL The Things&lt;/title&gt;'</span><span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTrue</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">endswith</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;/html&gt;'</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>Don&#8217;t forget to import <code>HttpRequest</code></p></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>TypeError: home_page() takes no arguments (1 given)</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Minimal code change:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests:
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.startswith('&lt;html&gt;'))
AttributeError: 'NoneType' object has no attribute 'content'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>http <span style="font-weight: bold"><span style="color: #000080">import</span></span> HttpResponse

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">HttpResponse</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests again:
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.startswith('&lt;html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code again:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">HttpResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;html&gt;'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests:
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: '&lt;title&gt;Poll ALL The Things&lt;/title&gt;' not found in '&lt;html&gt;'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Code:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">HttpResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;html&gt;&lt;title&gt;Poll ALL The Things&lt;/title&gt;'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Tests&#8201;&#8212;&#8201;almost there?
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.endswith('&lt;/html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
Come on, one last effort:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">HttpResponse</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;html&gt;&lt;title&gt;Poll ALL The Things&lt;/title&gt;&lt;/html&gt;'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Surely?
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python manage.py test polls
Creating test database for alias 'default'...
..
----------------------------------------------------------------------
Ran 2 tests in 0.001s

OK</code></pre>
</div></div>
<div class="paragraph"><p>Now we re-run our functional test, and we expect them to get past the
<code>assertIn</code> and stop on the <code>self.fail</code></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Can you rewrite the view as a one-liner?  Well done.  But don&#8217;t do that in real
life!</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_4_switching_to_templates">Part 4 - Switching to templates</h2>
<div class="sectionbody">
<div class="paragraph"><p>We extend the FT a little:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_voting_on_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Elspeth goes to check out a cool new polls site he's heard about</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8000'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># It is obviously all about polls:</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Poll'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span>title<span style="color: #990000">)</span>
        heading <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'h1'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>heading<span style="color: #990000">.</span>text<span style="color: #990000">,</span> <span style="color: #FF0000">'Current polls'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># She clicks on the link to the first Poll, which is titled</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># "How awesome is TDD?"</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_link_text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'How awesome is TDD?'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># She is taken to a poll 'results' page, which says</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># "No-one has voted on this poll yet"</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'finish this test'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure is:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element: {"method":"tag
name","selector":"h1"}' ; Stacktrace: [...]</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about: <code>find_element_by_tag_name</code> vs <code>find_elements_by_tag_name</code></td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_refactoring">Refactoring</h3>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about: &#8220;Don&#8217;t test constants&#8221;</td>
</tr></table>
</div>
<div class="paragraph"><p>We start with passing tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>python manage.py test polls
[...]
OK</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
make a new directory at polls/templates
</p>
</li>
</ul></div>
<div class="paragraph"><p>Then open a file at <em>polls/templates/home.html</em>, to which we&#8217;ll transfer our
HTML:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Poll ALL The Things<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Now change <em>polls/views.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>shortcuts <span style="font-weight: bold"><span style="color: #000080">import</span></span> render

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="color: #FF0000">'home.html'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Oops, an unexpected failure:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertTrue(response.content.endswith('&lt;/html&gt;'))
AssertionError: False is not true</code></pre>
</div></div>
<div class="paragraph"><p>Add a <code>print</code> statement to test to debug:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_home_page_returns_correct_html</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">HttpRequest</span></span><span style="color: #990000">()</span>
        response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTrue</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">startswith</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;html&gt;'</span><span style="color: #990000">))</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;title&gt;Poll ALL The Things&lt;/title&gt;'</span><span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="font-weight: bold"><span style="color: #000000">repr</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTrue</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">endswith</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;/html&gt;'</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>And fix, in your own way.</p></div>
<div class="paragraph"><p>Now we change the test:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[...]</span>
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>template<span style="color: #990000">.</span>loader <span style="font-weight: bold"><span style="color: #000080">import</span></span> render_to_string
<span style="color: #990000">[...]</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_home_page_renders_correct_template</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">HttpRequest</span></span><span style="color: #990000">()</span>
        response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>
        expected_html <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">render_to_string</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'home.html'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">,</span> expected_html<span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about the Django Test Client
NOTE: Ask me what Kent Beck said&#8201;&#8212;&#8201;"do I really expect you to always code like
    this?"</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_adding_the_h1_to_our_home_page">Adding the h1 to our home page:</h3>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Poll ALL The Things<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Current polls<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element:
{"method":"link text","selector":"How awesome is TDD?"}' ; Stacktrace:
[...]</code></pre>
</div></div>
<div class="paragraph"><p><strong>Hopefully we&#8217;ll have a break at this point!</strong></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>How would you test that we are returning valid (standards-compliant) HTML?</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_5_the_django_admin_site">Part 5 - The Django admin site</h2>
<div class="sectionbody">
<div class="paragraph"><p>Add a new test method to <em>functional_tests.py</em>:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>def test_can_create_a_new_poll_via_admin_site(self):
    # Mo the administrator goes to the admin page
    self.browser.get('http://localhost:8000/admin/')</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He sees the familiar 'Django administration' heading
body = self.browser.find_element_by_tag_name('body')
self.assertIn('Django administration', body.text)
self.fail('Finish this test')</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about&#8201;&#8212;&#8201;DONTifying tests</td>
</tr></table>
</div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: 'Django administration' not found in u"Page not found
(404)\nRequest Method: GET\nRequest URL:
http://localhost:8000/admin/\nUsing the URLconf defined in mysite.urls,
Django tried these URL patterns, in this order:\n^$ [name='home']\nThe
current URL, admin/, didn't match any of these.\nYou're seeing this error
because you have DEBUG = True in your Django settings file. Change that to
False, and Django will display a standard 404 page."</code></pre>
</div></div>
<div class="paragraph"><p>Switch on the admin involves uncommenting 3 lines in 2 files:</p></div>
<div class="paragraph"><p><em>mysite/settings.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>INSTALLED_APPS <span style="color: #990000">=</span> <span style="color: #990000">(</span>
    <span style="color: #FF0000">'django.contrib.auth'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.contenttypes'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.sessions'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.sites'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.messages'</span><span style="color: #990000">,</span>
    <span style="color: #FF0000">'django.contrib.staticfiles'</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable the admin:</span></span>
    <span style="color: #FF0000">'django.contrib.admin'</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable admin documentation:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># 'django.contrib.admindocs',</span></span>
    <span style="color: #FF0000">'polls'</span><span style="color: #990000">,</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>mysite/urls.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next two lines to enable the admin:</span></span>
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>contrib <span style="font-weight: bold"><span style="color: #000080">import</span></span> admin
admin<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">autodiscover</span></span><span style="color: #990000">()</span>

urlpatterns <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">patterns</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">,</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Examples:</span></span>
    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^$'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'polls.views.home_page'</span><span style="color: #990000">,</span> name<span style="color: #990000">=</span><span style="color: #FF0000">'home'</span><span style="color: #990000">),</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Uncomment the next line to enable the admin:</span></span>
    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^admin/'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">include</span></span><span style="color: #990000">(</span>admin<span style="color: #990000">.</span>site<span style="color: #990000">.</span>urls<span style="color: #990000">)),</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure (at the top of a long traceback):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: 'Django administration' not found in u'ImproperlyConfigured
at /admin/\nsettings.DATABASES is improperly configured. Please supply the
NAME value.\nRequest Method: GET\ [...]</code></pre>
</div></div>
<div class="paragraph"><p>Add a database name in <em>settings.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>DATABASES <span style="color: #990000">=</span> <span style="color: #990000">{</span>
    <span style="color: #FF0000">'default'</span><span style="color: #990000">:</span> <span style="color: #990000">{</span>
        <span style="color: #FF0000">'ENGINE'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'django.db.backends.sqlite3'</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">'NAME'</span><span style="color: #990000">:</span> <span style="color: #FF0000">'db.sqlite'</span><span style="color: #990000">,</span> <span style="font-style: italic"><span style="color: #9A1900"># Or path to database file if using sqlite3.</span></span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure (at the top of a long traceback):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: 'Django administration' not found in u"DatabaseError at
/admin/\nno such table: django_site\nRequest Method:</code></pre>
</div></div>
<div class="paragraph"><p>Run syncdb</p></div>
<div class="listingblock">
<div class="content">
<pre><code>python manage.py syncdb</code></pre>
</div></div>
<div class="paragraph"><p>Remember the username and password you use&#8201;&#8212;&#8201;I&#8217;m using <code>admin</code> and <code>adm1n</code></p></div>
<div class="paragraph"><p>Should now get to:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Finish this test</code></pre>
</div></div>
<div class="paragraph"><p>Now the FT should be able to log into the admin site:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_can_create_a_new_poll_via_admin_site</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Mo the administrator goes to the admin page</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'http://localhost:8000/admin/'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He sees the familiar 'Django administration' heading</span></span>
        body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Django administration'</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He types in his username and passwords and hits return</span></span>
        username_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username'</span><span style="color: #990000">)</span>
        username_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'admin'</span><span style="color: #990000">)</span>

        password_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'password'</span><span style="color: #990000">)</span>
        password_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'adm1n'</span><span style="color: #990000">)</span>
        password_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>Keys<span style="color: #990000">.</span>RETURN<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># His username and password are accepted, and he is taken to</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># the Site Administration page</span></span>
        body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Site administration'</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>

        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Use the admin site to create a poll'</span><span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Use the admin site to create a poll</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>What other methods could we have used, apart from <code>find_element_by_name</code>, to
find the username and password fields?  What about clicking instead of
pressing RETURN?</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_6_a_model_for_polls">Part 6: A model for Polls</h2>
<div class="sectionbody">
<div class="paragraph"><p>Extend the FT:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>[...]
# His username and password are accepted, and he is taken to
# the Site Administration page
body = self.browser.find_element_by_tag_name('body')
self.assertIn('Site administration', body.text)</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He sees a section named "Polls" with a model called "Polls" in it
polls_links = self.browser.find_elements_by_link_text('Polls')
self.assertEquals(len(polls_links), 2)
self.fail('Use the admin site to create a poll')</code></pre>
</div></div>
<div class="paragraph"><p>Expected failure:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEquals(len(polls_links), 2)
AssertionError: 0 != 2</code></pre>
</div></div>
<div class="paragraph"><p>Unit test for our Poll model:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>core<span style="color: #990000">.</span>urlresolvers <span style="font-weight: bold"><span style="color: #000080">import</span></span> resolve
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>http <span style="font-weight: bold"><span style="color: #000080">import</span></span> HttpRequest
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>template<span style="color: #990000">.</span>loader <span style="font-weight: bold"><span style="color: #000080">import</span></span> render_to_string
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>test <span style="font-weight: bold"><span style="color: #000080">import</span></span> TestCase
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>utils <span style="font-weight: bold"><span style="color: #000080">import</span></span> timezone
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Poll
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>views <span style="font-weight: bold"><span style="color: #000080">import</span></span> home_page

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollModelTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_creating_a_new_poll_and_saving_it_to_the_database</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># start by creating a new Poll object with its "question" set</span></span>
        poll <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">()</span>
        poll<span style="color: #990000">.</span>question <span style="color: #990000">=</span> <span style="color: #FF0000">"What's up?"</span>
        poll<span style="color: #990000">.</span>pub_date <span style="color: #990000">=</span> timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check we can save it to the database</span></span>
        poll<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># now check we can find it in the database again</span></span>
        all_polls_in_database <span style="color: #990000">=</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">()</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>all_polls_in_database<span style="color: #990000">),</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>
        only_poll_in_database <span style="color: #990000">=</span> all_polls_in_database<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>only_poll_in_database<span style="color: #990000">,</span> poll<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># and check that it's saved its two attributes: question and pub_date</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>only_poll_in_database<span style="color: #990000">.</span>question<span style="color: #990000">,</span> <span style="color: #FF0000">"What's up?"</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>only_poll_in_database<span style="color: #990000">.</span>pub_date<span style="color: #990000">,</span> poll<span style="color: #990000">.</span>pub_date<span style="color: #990000">)</span>


<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">HomePageTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_root_url_resolves_to_home_page_view</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="color: #990000">[...]</span></tt></pre></div></div>
<div class="paragraph"><p>Don&#8217;t miss the 2 extra imports (I did!)</p></div>
<div class="ulist"><ul>
<li>
<p>
Expected failure:
</p>
<div class="literalblock">
<div class="content">
<pre><code>ImportError: cannot import name Poll</code></pre>
</div></div>
</li>
<li>
<p>
Now edit <em>polls/models.py</em>:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>db <span style="font-weight: bold"><span style="color: #000080">import</span></span> models

Poll <span style="color: #990000">=</span> None</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Expected failure:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>TypeError: 'NoneType' object is not callable
    ImportError: cannot import name Poll</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<em>models.py</em>:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>db <span style="font-weight: bold"><span style="color: #000080">import</span></span> models

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>object<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
failure:
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Poll' object has no attribute 'save'</code></pre>
</div></div>
</li>
<li>
<p>
inherit:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
failure - note it&#8217;s quite late!
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Poll' object has no attribute 'question'</code></pre>
</div></div>
</li>
<li>
<p>
add question attribute
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    question <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
new failure:
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Poll' object has no attribute 'pub_date'</code></pre>
</div></div>
</li>
<li>
<p>
new field - deliberately wrong:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    question <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span>
    pub_date <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
sure enough, tests help us:
</p>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: u'2013-03-03 12:40:29.241235+00:00' !=
datetime.datetime(2013, 3, 3, 12, 40, 29, 241235, tzinfo=&lt;UTC&gt;)</code></pre>
</div></div>
</li>
<li>
<p>
fix
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    pub_date <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">DateTimeField</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
and it should now work!
</p>
</li>
</ul></div>
<div class="literalblock">
<div class="content">
<pre><code>$ python manage.py test polls
Creating test database for alias 'default'...
...
----------------------------------------------------------------------
Ran 3 tests in 0.008s

OK</code></pre>
</div></div>
<div class="paragraph"><p>Do the FTs pass?  No, still need to <em>register</em> Polls in the admin site,
using a new file at <em>polls/admin.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>contrib <span style="font-weight: bold"><span style="color: #000080">import</span></span> admin
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Poll

admin<span style="color: #990000">.</span>site<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">register</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>And now we should get our self.fail:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Use the admin site to create a poll</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Give pub_date a verbose name of <em>Date published</em>. See the
official tutorial for the implementation&#8230; but can you find a way to unit test
it?  Hint: the model <code>._meta</code> attribute might work&#8230; Is there another way?</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Part 7: LiveServerTestCase and test fixtures</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Start by extending the FT to actually create a new poll via the admin site:

[source,python]</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He clicks the 'Add poll' link
new_poll_link = self.browser.find_element_by_link_text('Add poll')
new_poll_link.click()</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He types in an interesting question for the Poll
question_field = self.browser.find_element_by_name('question')
question_field.send_keys("How awesome is Test-Driven Development?")</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He sets the date and time of publication - it'll be a new year's
# poll!
date_field = self.browser.find_element_by_name('pub_date_0')
date_field.send_keys('01/01/12')
time_field = self.browser.find_element_by_name('pub_date_1')
time_field.send_keys('00:00')</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># Mo clicks the save button
save_button = self.browser.find_element_by_css_selector("input[value='Save']")
save_button.click()</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code># He is returned to the "Polls" listing, where he can see his
# new poll, listed as a clickable link
new_poll_links = self.browser.find_elements_by_link_text(
        "How awesome is Test-Driven Development?"
)
self.assertEquals(len(new_poll_links), 1)</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>First expected fail -</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertEquals(len(new_poll_links), 1)
AssertionError: 0 != 1</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>`__unicode__`
~~~~~~~~~~~~~

Fix by changing the string representation of a poll:

in 'polls/tests.py', add to `PollModelTest`:


[source,python]</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def test_string_representation(self):
    poll = Poll()
    poll.question = "Why?"
    self.assertEqual(unicode(poll), "Why?")</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>Expected fail:

    AssertionError: u'Poll object' != 'Why?'

'models.py':


[source,python]</code></pre>
</div></div>
<div class="paragraph"><p>class Poll(models.Model):
    question = models.CharField(max_length=200)
    pub_date = models.DateTimeField()</p></div>
<div class="literalblock">
<div class="content">
<pre><code>def __unicode__(self):
    return self.question</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>Unit tests should now pass

LiveServerTestCase and the test database
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Functional tests should pass once... but fail the second time:</code></pre>
</div></div>
<div class="paragraph"><p>AssertionError: <em>0 polls</em> not found in u&#8217;Django administration\nWelcome, admin.
Change password / Log out\nHome \u203a Polls \u203a Polls\nSelect poll to
change\nAdd poll\nAction:\n---------\nDelete selected polls\nGo 0 of 1
selected\nPoll\nHow awesome is Test-Driven Development?\n1 poll'</p></div>
<div class="listingblock">
<div class="content">
<pre><code>change 'functional_tests.py' to being tests inside a new Django app called 'fts':</code></pre>
</div></div>
<div class="paragraph"><p>python manage.py startapp fts
mv functional_tests.py fts/tests.py</p></div>
<div class="listingblock">
<div class="content">
<pre><code>then edit 'fts/tests.py' to inherit from `LiveServerTestCase`:


[source,python]</code></pre>
</div></div>
<div class="paragraph"><p>from django.test import LiveServerTestCase
from selenium import webdriver
from selenium.webdriver.common.keys import Keys</p></div>
<div class="paragraph"><p>class PollsFunctionalTest(LiveServerTestCase):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>def setUp(self):
    self.browser = webdriver.Firefox()
    self.browser.implicitly_wait(3)</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def tearDown(self):
    self.browser.quit()</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def test_voting_on_a_poll(self):
    # Elspeth goes to check out a cool new polls site she's heard about
    self.browser.get(self.live_server_url)</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>[...]</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def test_can_create_a_new_poll_via_admin_site(self):
    # Mo the administrator goes to the admin page
    self.browser.get(self.live_server_url + '/admin/')
    [...]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>* make sure to use `self.live_server_url` in both test methods
* also delete the `if __name__ == __main__` block

Add `fts` to 'settings.py':

[source,python]</code></pre>
</div></div>
<div class="paragraph"><p>INSTALLED_APPS = (
    <em>django.contrib.auth</em>,
    <em>django.contrib.contenttypes</em>,
    <em>django.contrib.sessions</em>,
    <em>django.contrib.sites</em>,
    <em>django.contrib.messages</em>,
    <em>django.contrib.staticfiles</em>,
    # Uncomment the next line to enable the admin:
    <em>django.contrib.admin</em>,
    # Uncomment the next line to enable admin documentation:
    # <em>django.contrib.admindocs</em>,
    <em>polls</em>,
    <em>fts</em>,
)</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Now run</code></pre>
</div></div>
<div class="paragraph"><p>$ python manage.py test fts</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Should see one `self.fail` (can DONTify this test now) and one:</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertIn('Site administration', body.text)
AssertionError: 'Site administration' not found in u'Django
administration\nPlease enter the correct username and password for a staff
account. Note that both fields may be case-sensitive.\nUsername:\nPassword:\n '</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>Test fixture setup
~~~~~~~~~~~~~~~~~~

* make a new directory at 'polls/fixtures'</code></pre>
</div></div>
<div class="paragraph"><p>python manage.py dumpdata auth.user &gt; polls/fixtures/admin_user.json</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Add to 'fts/tests.py':

[source,python]</code></pre>
</div></div>
<div class="paragraph"><p>class PollsFunctionalTest(LiveServerTestCase):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>fixtures = ['admin_user.json']</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def setUp(self):
    [...]</code></pre>
</div></div>
<div class="listingblock">
<div class="content">
<pre><code>FT should now pass, no matter how many times you run them!

By the end, your folder structure should look like this:</code></pre>
</div></div>
<div class="paragraph"><p>.
|-- fts
|   |-- <em>init</em>.py
|   |-- models.py
|   |-- tests.py
|   `-- views.py
|-- manage.py
|-- mysite
|   |-- <em>init</em>.py
|   |-- settings.py
|   |-- urls.py
|   `-- wsgi.py
`-- polls
    |-- admin.py
    |-- fixtures
    |   `-- admin_user.json
    |-- <em>init</em>.py
    |-- models.py
    |-- templates
    |   `-- home.html
    |-- tests.py
    `-- views.py</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Part 8 - Add the Choice model</code></pre>
</div></div>
<div class="paragraph"><p>Add a bit to the FT (<em>fts/tests.py</em>), just before we save the new poll</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-style: italic"><span style="color: #9A1900"># He sets the date and time of publication - it'll be a new year's</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># poll!</span></span>
    date_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'pub_date_0'</span><span style="color: #990000">)</span>
    date_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'01/01/12'</span><span style="color: #990000">)</span>
    time_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'pub_date_1'</span><span style="color: #990000">)</span>
    time_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'00:00'</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># He sees he can enter choices for the Poll.  He adds three</span></span>
    choice_1 <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'choice_set-0-choice'</span><span style="color: #990000">)</span>
    choice_1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Very awesome'</span><span style="color: #990000">)</span>
    choice_2 <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'choice_set-1-choice'</span><span style="color: #990000">)</span>
    choice_2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Quite awesome'</span><span style="color: #990000">)</span>
    choice_3 <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'choice_set-2-choice'</span><span style="color: #990000">)</span>
    choice_3<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Moderately awesome'</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Mo clicks the save button</span></span>
    save_button <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_css_selector</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"input[value='Save']"</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected failure for <code>manage.py test fts</code>:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element:
{"method":"name","selector":"choice_set-0-choice"}' ; Stacktrace: [...]</code></pre>
</div></div>
<div class="paragraph"><p>Now in the unit tests - <em>polls/tests.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="color: #990000">[...]</span>
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>utils <span style="font-weight: bold"><span style="color: #000080">import</span></span> timezone
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Choice<span style="color: #990000">,</span> Poll
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>views <span style="font-weight: bold"><span style="color: #000080">import</span></span> home_page

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollModelTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>
    <span style="color: #990000">[...]</span>


<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">ChoiceModelTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_creating_some_choices_for_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># start by creating a new Poll object</span></span>
        poll <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">()</span>
        poll<span style="color: #990000">.</span>question<span style="color: #990000">=</span><span style="color: #FF0000">"What's up?"</span>
        poll<span style="color: #990000">.</span>pub_date <span style="color: #990000">=</span> timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">()</span>
        poll<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># now create a Choice object</span></span>
        choice <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># link it with our Poll</span></span>
        choice<span style="color: #990000">.</span>poll <span style="color: #990000">=</span> poll

        <span style="font-style: italic"><span style="color: #9A1900"># give it some text</span></span>
        choice<span style="color: #990000">.</span>choice <span style="color: #990000">=</span> <span style="color: #FF0000">"doin' fine..."</span>

        <span style="font-style: italic"><span style="color: #9A1900"># and let's say it's had some votes</span></span>
        choice<span style="color: #990000">.</span>votes <span style="color: #990000">=</span> <span style="color: #993399">3</span>

        <span style="font-style: italic"><span style="color: #9A1900"># save it</span></span>
        choice<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># try retrieving it from the database, using the poll object's reverse</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># lookup</span></span>
        poll_choices <span style="color: #990000">=</span> poll<span style="color: #990000">.</span>choice_set<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">()</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>poll_choices<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">count</span></span><span style="color: #990000">(),</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># finally, check its attributes have been saved</span></span>
        choice_from_db <span style="color: #990000">=</span> poll_choices<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choice_from_db<span style="color: #990000">.</span>id<span style="color: #990000">,</span> choice<span style="color: #990000">.</span>id<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choice_from_db<span style="color: #990000">.</span>choice<span style="color: #990000">,</span> <span style="color: #FF0000">"doin' fine..."</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choice_from_db<span style="color: #990000">.</span>votes<span style="color: #990000">,</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Expected failure:
</p>
<div class="literalblock">
<div class="content">
<pre><code>ImportError: cannot import name Choice</code></pre>
</div></div>
</li>
<li>
<p>
<em>polls/models.py</em>:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>object<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
Then
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Choice' object has no attribute 'save'</code></pre>
</div></div>
</li>
<li>
<p>
<em>models.py</em>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
tests:
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Poll' object has no attribute 'choice_set'</code></pre>
</div></div>
</li>
<li>
<p>
<em>models.py</em>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ForeignKey</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
tests:
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEquals(choice_from_db.choice, "doin' fine...")
AttributeError: 'Choice' object has no attribute 'choice'</code></pre>
</div></div>
<div class="ulist"><ul>
<li>
<p>
<em>models.py</em>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ForeignKey</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">)</span>
    choice <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="ulist"><ul>
<li>
<p>
tests:
</p>
<div class="literalblock">
<div class="content">
<pre><code>AttributeError: 'Choice' object has no attribute 'votes'</code></pre>
</div></div>
</li>
<li>
<p>
<em>models.py</em>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ForeignKey</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">)</span>
    choice <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span>
    votes <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">IntegerField</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>Now, in <em>polls/admin.py</em></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>contrib <span style="font-weight: bold"><span style="color: #000080">import</span></span> admin
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Choice<span style="color: #990000">,</span> Poll

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">ChoiceInline</span></span><span style="color: #990000">(</span>admin<span style="color: #990000">.</span>StackedInline<span style="color: #990000">):</span>
    model <span style="color: #990000">=</span> Choice
    extra <span style="color: #990000">=</span> <span style="color: #993399">3</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollAdmin</span></span><span style="color: #990000">(</span>admin<span style="color: #990000">.</span>ModelAdmin<span style="color: #990000">):</span>
    inlines <span style="color: #990000">=</span> <span style="color: #990000">[</span>ChoiceInline<span style="color: #990000">]</span>

admin<span style="color: #990000">.</span>site<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">register</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">,</span> PollAdmin<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Run the FT - still fails:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>    self.assertEquals(len(new_poll_links), 1)
AssertionError: 0 != 1</code></pre>
</div></div>
<div class="paragraph"><p>Inspect manually</p></div>
<div class="paragraph"><p>Need to add a default:</p></div>
<div class="paragraph"><p>in <em>polls/tests.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">ChoiceModelTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_creating_some_choices_for_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="color: #990000">[...]</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_choice_defaults</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        choice <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">()</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choice<span style="color: #990000">.</span>votes<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><em>polls/models.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>models<span style="color: #990000">.</span>Model<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ForeignKey</span></span><span style="color: #990000">(</span>Poll<span style="color: #990000">)</span>
    choice <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">CharField</span></span><span style="color: #990000">(</span>max_length<span style="color: #990000">=</span><span style="color: #993399">200</span><span style="color: #990000">)</span>
    votes <span style="color: #990000">=</span> models<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">IntegerField</span></span><span style="color: #990000">(</span>default<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>FT should now pass</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">ask me about: <code>TemplateDoesNotExist: 500.html</code> and <code>settings.DEBUG</code></td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Figure out how to fix the <code>TemplateDoesNotExist: 500.html</code> issue</p></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_9_the_page_pattern">Part 9 - The Page pattern</h2>
<div class="sectionbody">
<div class="paragraph"><p>Start by refactoring the admin ft:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> datetime <span style="font-weight: bold"><span style="color: #000080">import</span></span> datetime
<span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>test <span style="font-weight: bold"><span style="color: #000080">import</span></span> LiveServerTestCase
<span style="font-weight: bold"><span style="color: #000080">from</span></span> selenium <span style="font-weight: bold"><span style="color: #000080">import</span></span> webdriver
<span style="font-weight: bold"><span style="color: #000080">from</span></span> selenium<span style="color: #990000">.</span>webdriver<span style="color: #990000">.</span>common<span style="color: #990000">.</span>keys <span style="font-weight: bold"><span style="color: #000080">import</span></span> Keys

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">AdminPage</span></span><span style="color: #990000">(</span>object<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> test<span style="color: #990000">,</span> browser<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>test <span style="color: #990000">=</span> test
        self<span style="color: #990000">.</span>browser <span style="color: #990000">=</span> browser

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">login</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Mo the administrator goes to the admin page</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>test<span style="color: #990000">.</span>live_server_url <span style="color: #990000">+</span> <span style="color: #FF0000">'/admin/'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He sees the familiar 'Django administration' heading</span></span>
        body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>test<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Django administration'</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He types in his username and passwords and hits return</span></span>
        username_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'username'</span><span style="color: #990000">)</span>
        username_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'admin'</span><span style="color: #990000">)</span>

        password_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'password'</span><span style="color: #990000">)</span>
        password_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'adm1n'</span><span style="color: #990000">)</span>
        password_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>Keys<span style="color: #990000">.</span>RETURN<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># His username and password are accepted, and he is taken to</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># the Site Administration page</span></span>
        body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>test<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Site administration'</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>


    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_link_text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Log out'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>


    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">add_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> question<span style="color: #990000">,</span> pub_date<span style="color: #990000">,</span> choices<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>test<span style="color: #990000">.</span>live_server_url <span style="color: #990000">+</span> <span style="color: #FF0000">'/admin/'</span><span style="color: #990000">)</span>
        <span style="font-style: italic"><span style="color: #9A1900"># He sees a section named "Polls" with a model called "Polls" in it</span></span>
        polls_links <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_elements_by_link_text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Polls'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>test<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>polls_links<span style="color: #990000">),</span> <span style="color: #993399">2</span><span style="color: #990000">)</span>
        polls_links<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He clicks the 'Add poll' link</span></span>
        new_poll_link <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_link_text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Add poll'</span><span style="color: #990000">)</span>
        new_poll_link<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He types in an interesting question for the Poll</span></span>
        question_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'question'</span><span style="color: #990000">)</span>
        question_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>question<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He sets the date and time of publication</span></span>
        date_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'pub_date_0'</span><span style="color: #990000">)</span>
        date_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>pub_date<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">date</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">strftime</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'%x'</span><span style="color: #990000">))</span>
        time_field <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'pub_date_1'</span><span style="color: #990000">)</span>
        time_field<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>pub_date<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">time</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">strftime</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'%X'</span><span style="color: #990000">))</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He sees he can enter choices for the Poll.  He adds them</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> no<span style="color: #990000">,</span> choice <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="font-weight: bold"><span style="color: #000000">enumerate</span></span><span style="color: #990000">(</span>choices<span style="color: #990000">):</span>
            choice_input <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_name</span></span><span style="color: #990000">(</span>
                <span style="color: #FF0000">'choice_set-%d-choice'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>no<span style="color: #990000">,)</span>
            <span style="color: #990000">)</span>
            choice_input<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_keys</span></span><span style="color: #990000">(</span>choice<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># Mo clicks the save button</span></span>
        save_button <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_css_selector</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"input[value='Save']"</span><span style="color: #990000">)</span>
        save_button<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># He is returned to the "Polls" listing, where he can see his</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># new poll, listed as a clickable link</span></span>
        new_poll_links <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_elements_by_link_text</span></span><span style="color: #990000">(</span>
                question
        <span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>test<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>new_poll_links<span style="color: #990000">),</span> <span style="color: #993399">1</span><span style="color: #990000">)</span>



<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollsFunctionalTest</span></span><span style="color: #990000">(</span>LiveServerTestCase<span style="color: #990000">):</span>

    <span style="color: #990000">[...]</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_voting_on_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="color: #990000">[...]</span>


    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_can_create_a_new_poll_via_admin_site</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Mo the administrator goes to the admin page</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># and creates a new poll, with 3 choices</span></span>
        admin_page <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">AdminPage</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">)</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">login</span></span><span style="color: #990000">()</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_poll</span></span><span style="color: #990000">(</span>
            question<span style="color: #990000">=</span><span style="color: #FF0000">"How awesome is Test-Driven Development?"</span><span style="color: #990000">,</span>
            pub_date<span style="color: #990000">=</span><span style="font-weight: bold"><span style="color: #000000">datetime</span></span><span style="color: #990000">(</span><span style="color: #993399">2012</span><span style="color: #990000">,</span><span style="color: #993399">01</span><span style="color: #990000">,</span><span style="color: #993399">01</span><span style="color: #990000">),</span>
            choices <span style="color: #990000">=</span> <span style="color: #990000">[</span><span style="color: #FF0000">'Very awesome'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Quite awesome'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Moderately awesome'</span><span style="color: #990000">]</span>
        <span style="color: #990000">)</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Ask me about: &#8220;Three strikes then refactor&#8221;</td>
</tr></table>
</div>
<div class="paragraph"><p>Check it works by running <code>python manage.py test fts</code>.</p></div>
<div class="paragraph"><p>Then, use our new AdminPage to pre-populate some polls for our other FT:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_voting_on_a_poll</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># Mo the administrator has entered a couple of polls</span></span>
        admin_page <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">AdminPage</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">)</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">login</span></span><span style="color: #990000">()</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_poll</span></span><span style="color: #990000">(</span>
            question<span style="color: #990000">=</span><span style="color: #FF0000">"How awesome is TDD?"</span><span style="color: #990000">,</span>
            pub_date <span style="color: #990000">=</span> datetime<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">today</span></span><span style="color: #990000">(),</span>
            choices<span style="color: #990000">=[</span><span style="color: #FF0000">'Very awesome'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Quite awesome'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Moderately awesome'</span><span style="color: #990000">],</span>
        <span style="color: #990000">)</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_poll</span></span><span style="color: #990000">(</span>
            question<span style="color: #990000">=</span><span style="color: #FF0000">"Which workshop treat do you prefer?"</span><span style="color: #990000">,</span>
            pub_date <span style="color: #990000">=</span> datetime<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">today</span></span><span style="color: #990000">(),</span>
            choices<span style="color: #990000">=[</span><span style="color: #FF0000">'Beer'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'Pizza'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'The Acquisition of Knowledge'</span><span style="color: #990000">],</span>
        <span style="color: #990000">)</span>
        admin_page<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">logout</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># Elspeth goes to check out a cool new polls site she's heard about</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>live_server_url<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># It is obviously all about polls:</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Poll'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span>title<span style="color: #990000">)</span>
        heading <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'h1'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>heading<span style="color: #990000">.</span>text<span style="color: #990000">,</span> <span style="color: #FF0000">'Current polls'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># She clicks on the link to the first Poll, which is titled</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># "How awesome is TDD?"</span></span>
        self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_link_text</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'How awesome is TDD?'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># She is taken to a poll 'results' page, which says</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># "No-one has voted on this poll yet"</span></span>
        body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
        self<span style="color: #990000">.</span>test<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"No-one has voted on this poll yet"</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>
        <span style="font-style: italic"><span style="color: #9A1900"># She also sees a form, which offers her several choices.</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># There are three options with radio buttons</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'finish this test'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Expected fail:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element:
{"method":"link text","selector":"How awesome is TDD?"}' [...]</code></pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Remove some of the duplicated strings like the poll question, and use some
constants instead</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_fixing_that_darned_500_template_error">Fixing that darned 500 template error!</h3>
<div class="paragraph"><p>It&#8217;s about time we sorted this out!</p></div>
<div class="listingblock">
<div class="content">
<pre><code>mkdir mysite/templates
echo "Unexpected Error (500) :-/" &gt; mysite/templates/500.html</code></pre>
</div></div>
<div class="paragraph"><p>then, in <em>mysite/settings.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> os
<span style="color: #990000">[...]</span>
TEMPLATE_DIRS <span style="color: #990000">=</span> <span style="color: #990000">(</span>
    <span style="font-style: italic"><span style="color: #9A1900"># Put strings here, like "/home/html/django_templates" or "C:/www/django/templates".</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># Always use forward slashes, even on Windows.</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># Don't forget to use absolute paths, not relative paths.</span></span>
    os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">join</span></span><span style="color: #990000">(</span>os<span style="color: #990000">.</span>path<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dirname</span></span><span style="color: #990000">(</span>__file__<span style="color: #990000">),</span> <span style="color: #FF0000">'templates'</span><span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">replace</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'\\'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'/'</span><span style="color: #990000">),</span>
<span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_10_listing_polls_on_the_home_page_template">Part 10 - Listing polls on the home page template</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Skipping ahead to this section</div>
<div class="paragraph"><p>From the top-level folder of the repo</p></div>
<div class="literalblock">
<div class="content">
<pre><code>git stash # if you want to save what you had so far
git checkout PYCON_2013_PART_10 -- mysite</code></pre>
</div></div>
<div class="paragraph"><p>Those two commands will blow away everything in <em>mysite</em> and replace them
with versions as if you&#8217;d skipped to this part</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><code>python manage.py test fts</code> should give:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element: {"method":"link
text","selector":"How awesome is TDD?"}'</code></pre>
</div></div>
<div class="paragraph"><p>So start by adding check for poll questions to our view unit test. In
<em>polls/tests.py</em>, change <code>test_home_page_renders_correct_template</code> inside
<code>HomePageTest</code>, to:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_home_page_renders_home_template_with_current_polls</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># set up some polls</span></span>
    poll1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'6 times 7'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
    poll1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
    poll2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'life, the universe and everything'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
    poll2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

    request <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">HttpRequest</span></span><span style="color: #990000">()</span>
    response <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># check template rendered correctly</span></span>
    expected_html <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">render_to_string</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'home.html'</span><span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">,</span> expected_html<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># check template includes all polls</span></span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>poll1<span style="color: #990000">.</span>question<span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>poll2<span style="color: #990000">.</span>question<span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
</tt></pre></div></div>
<div class="paragraph"><p>Should fail:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '6 times 7' not found in '&lt;html&gt;\n    &lt;head&gt;\n
&lt;title&gt;Poll ALL The Things&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n
&lt;h1&gt;Current polls&lt;/h1&gt;\n    &lt;/body&gt;\n&lt;/html&gt;\n'</code></pre>
</div></div>
<div class="paragraph"><p>Now add them to our template, <em>polls/templates/home.html</em>, using special Django
template tags&#8201;&#8212;&#8201;<code>{% %}</code> and <code>{{ }}</code></p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Poll ALL The Things<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Current polls<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
        {% for poll in current_polls %}
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/li&gt;</span></span>
        {% endfor %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Tests still fail - v. slightly different error.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">ask me about&#8201;&#8212;&#8201;Django template syntax. obviously</td>
</tr></table>
</div>
<div class="paragraph"><p>Where would <code>current_polls</code> come from?  They&#8217;re actually passed into the render
call - we can test that! In <em>polls/tests.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    expected_html <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">render_to_string</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'home.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'current_polls'</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>poll1<span style="color: #990000">,</span> poll2<span style="color: #990000">]})</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEqual</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">,</span> expected_html<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now test failure happens earlier :</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEqual(response.content, expected_html)
AssertionError: '&lt;html&gt;\n    &lt;head&gt;\n        &lt;title&gt;Poll ALL The
Things&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n        &lt;h1&gt;Current polls&lt;/h1&gt;\n
&lt;ul&gt;\n        \n        &lt;/ul&gt;\n    &lt;/body&gt;\n&lt;/html&gt;\n' != u'&lt;html&gt;\n &lt;head&gt;\n
&lt;title&gt;Poll ALL The Things&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n &lt;h1&gt;Current
polls&lt;/h1&gt;\n        &lt;ul&gt;\n        \n            &lt;li&gt;6 times 7&lt;/li&gt;\n        \n
&lt;li&gt;life, the universe and everything&lt;/li&gt;\n        \n        &lt;/ul&gt;\n
&lt;/body&gt;\n&lt;/html&gt;\n'</code></pre>
</div></div>
<div class="paragraph"><p>Yuk!  Let&#8217;s try using <code>assertMultiLineEqual</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-style: italic"><span style="color: #9A1900"># render template with polls</span></span>
    expected_html <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">render_to_string</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'home.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'current_polls'</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>poll1<span style="color: #990000">,</span> poll2<span style="color: #990000">]})</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertMultiLineEqual</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>content<span style="color: #990000">,</span> expected_html<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Much better:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '&lt;html&gt;\n    &lt;head&gt;\n        &lt;title&gt;Poll ALL The
Things&lt;/title&gt;\n    &lt;/head&gt;\n   [truncated]... != u'&lt;html&gt;\n    &lt;head&gt;\n
&lt;title&gt;Poll ALL The Things&lt;/title&gt;\n    &lt;/head&gt;\n  [truncated]...
  &lt;html&gt;
      &lt;head&gt;
          &lt;title&gt;Poll ALL The Things&lt;/title&gt;
      &lt;/head&gt;
      &lt;body&gt;
          &lt;h1&gt;Current polls&lt;/h1&gt;
          &lt;ul&gt;
+             &lt;li&gt;6 times 7&lt;/li&gt;
+
+             &lt;li&gt;life, the universe and everything&lt;/li&gt;
+
          &lt;/ul&gt;
      &lt;/body&gt;
  &lt;/html&gt;</code></pre>
</div></div>
<div class="paragraph"><p>Fix in <em>polls/views.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>shortcuts <span style="font-weight: bold"><span style="color: #000080">import</span></span> render
<span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Poll

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">home_page</span></span><span style="color: #990000">(</span>request<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="color: #FF0000">'home.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'current_polls'</span><span style="color: #990000">:</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">all</span></span><span style="color: #990000">()})</span></tt></pre></div></div>
<div class="paragraph"><p>Unit tests should now pass - how about FTs? Not quite - but they do get further</p></div>
<div class="listingblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element: {"method":"link
text","selector":"How awesome is TDD?"}' ;</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s make our poll questions into hyperlinks in the template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    {% for poll in current_polls %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;a&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
    {% endfor %}</tt></pre></div></div>
<div class="paragraph"><p>FT gets a little further</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'No-one has voted on this poll yet' not found in u'Current
polls\nHow awesome is TDD?\nWhich workshop treat do you prefer?'</code></pre>
</div></div>
</div>
</div>
<div class="sect1">
<h2 id="_part_11_viewing_a_poll_and_the_django_test_client">Part 11 - viewing a poll and the Django Test Client</h2>
<div class="sectionbody">
<div class="paragraph"><p>We want individual polls to have their own URL - let&#8217;s specify that in
<em>polls/templates/home.html</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>Poll ALL The Things<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>Current polls<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
        {% for poll in current_polls %}
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;a</span></span> <span style="color: #009900">href</span><span style="color: #990000">=</span><span style="color: #FF0000">"/poll/{{ poll.id }}/"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/a&gt;&lt;/li&gt;</span></span>
        {% endfor %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Of course that URL doesn&#8217;t exist yet - try running the FT and you&#8217;ll get a
500 server error</p></div>
<div class="paragraph"><p>So let&#8217;s add a test for our new url, in <em>polls/tests.py</em>. This time we
use the <em>Django Test Client</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> polls <span style="font-weight: bold"><span style="color: #000080">import</span></span> views
<span style="color: #990000">[...]</span>
<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">HomePageTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>
    <span style="color: #990000">[...]</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">SinglePollViewTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_page_shows_poll_title_and_no_votes_message</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># set up two polls, to check the right one is displayed</span></span>
        poll1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'6 times 7'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
        poll1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
        poll2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'life, the universe and everything'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
        poll2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        response <span style="color: #990000">=</span> self<span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/poll/%d/'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll2<span style="color: #990000">.</span>id<span style="color: #990000">,</span> <span style="color: #990000">))</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check we've used the poll template</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTemplateUsed</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span> <span style="color: #FF0000">'poll.html'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check we've passed the right poll into the context</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>context<span style="color: #990000">[</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">],</span> poll2<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check the poll's question appears on the page</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>poll2<span style="color: #990000">.</span>question<span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check our 'no votes yet' message appears</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'No-one has voted on this poll yet'</span><span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>gives :</p></div>
<div class="literalblock">
<div class="content">
<pre><code>TemplateDoesNotExist: 404.html</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s add a minimal 404 template, just like we did for the 500:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>echo "Page not found (404) :-/" &gt; mysite/templates/404.html</code></pre>
</div></div>
<div class="paragraph"><p>Now we get:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: Template 'poll.html' was not a template used to render the
response. Actual template(s) used: 404.html</code></pre>
</div></div>
<div class="paragraph"><p>OK, so let&#8217;s fix the 404. Here&#8217;s a possible fix in <em>mysite/urls.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>urlpatterns <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">patterns</span></span><span style="color: #990000">(</span><span style="color: #FF0000">''</span><span style="color: #990000">,</span>
    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^$'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'polls.views.home_page'</span><span style="color: #990000">,</span> name<span style="color: #990000">=</span><span style="color: #FF0000">'home'</span><span style="color: #990000">),</span>
    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^poll/(\d+)/$'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'polls.views.poll'</span><span style="color: #990000">,</span> name<span style="color: #990000">=</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">),</span>

    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^admin/'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">include</span></span><span style="color: #990000">(</span>admin<span style="color: #990000">.</span>site<span style="color: #990000">.</span>urls<span style="color: #990000">)),</span>
<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>which gives</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ViewDoesNotExist: Could not import polls.views.poll. View does not exist in
module polls.views.</code></pre>
</div></div>
<div class="paragraph"><p>Now enter a TDD/code cycle. I will show just the failures:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>TypeError: poll() takes exactly 1 argument (2 given)</code></pre>
</div></div>
<div class="paragraph"><p>Then:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ValueError: The view polls.views.poll didn't return an HttpResponse object.</code></pre>
</div></div>
<div class="paragraph"><p>Then:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: No templates used to render the response</code></pre>
</div></div>
<div class="paragraph"><p>(deliberate mistake)</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: Template 'poll.html' was not a template used to render the response. Actual template(s) used: home.html</code></pre>
</div></div>
<div class="paragraph"><p>Then:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>TemplateDoesNotExist: poll.html</code></pre>
</div></div>
<div class="paragraph"><p>So we create it! minimally, at <em>polls/templates/poll.html</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And now:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEquals(response.context['poll'], poll2)
  File "/usr/local/lib/python2.7/dist-packages/django/template/context.py", line 54, in __getitem__
    raise KeyError(key)
KeyError: 'poll'</code></pre>
</div></div>
<div class="paragraph"><p>So we pass poll in our context:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">poll</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> poll_id<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="color: #FF0000">'poll.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">:</span> None<span style="color: #990000">})</span></tt></pre></div></div>
<div class="paragraph"><p>tests:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: None != &lt;Poll: life, the universe and everything&gt;</code></pre>
</div></div>
<div class="paragraph"><p>So:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">poll</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> poll_id<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">=</span>poll_id<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="color: #FF0000">'poll.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">:</span> poll<span style="color: #990000">})</span></tt></pre></div></div>
<div class="paragraph"><p>gives</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'life, the universe and everything' not found in
'&lt;html&gt;\n&lt;/html&gt;\n'</code></pre>
</div></div>
<div class="paragraph"><p>So improve the template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">&lt;html&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;head&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;title&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/title&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/head&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">&lt;/html&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And then:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'No-one has voted on this poll yet' not found in '&lt;html&gt;\n
&lt;head&gt;\n        &lt;title&gt;life, the universe and everything&lt;/title&gt;\n    &lt;/head&gt;\n
&lt;body&gt;\n        &lt;h1&gt;life, the universe and everything&lt;/h1&gt;\n
&lt;/body&gt;\n&lt;/html&gt;\n'</code></pre>
</div></div>
<div class="paragraph"><p>So, for now:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">&lt;body&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>No-one has voted on this poll yet<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/body&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>FT should now get to the <code>self.fail</code></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced tasks</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Figure out how to use <strong>url includes</strong> to put the poll url into
<em>polls/urls.py</em> instead of <em>mysite/urls.py</em>
</p>
</li>
<li>
<p>
DRY! We shouldn&#8217;t have these URL strings hard-coded all over the place. Find
out how to remove them from the template
</p>
</li>
<li>
<p>
Look up how template inheritance works in Django.  Make <em>poll.html</em> and
<em>home.html</em> inherit from a common base template.
</p>
</li>
</ol></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_12_voting_on_a_poll">Part 12 - voting on a poll</h2>
<div class="sectionbody">
<div class="paragraph"><p>We extend the FT</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"No-one has voted on this poll yet"</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># She also sees a form, which offers her several choices.</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># There are three options with radio buttons</span></span>
    choice_inputs <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_elements_by_css_selector</span></span><span style="color: #990000">(</span>
<span style="font-style: italic"><span style="color: #9A1900">            "input[type='radio']"</span></span>
    <span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">len</span></span><span style="color: #990000">(</span>choice_inputs<span style="color: #990000">),</span> <span style="color: #993399">3</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># The buttons have labels to explain them</span></span>
    choice_labels <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_elements_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'label'</span><span style="color: #990000">)</span>
    choices_text <span style="color: #990000">=</span> <span style="color: #990000">[</span>c<span style="color: #990000">.</span>text <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> c <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> choice_labels<span style="color: #990000">]</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choices_text<span style="color: #990000">,</span> <span style="color: #990000">[</span>
        <span style="color: #FF0000">'Very awesome'</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">'Quite awesome'</span><span style="color: #990000">,</span>
        <span style="color: #FF0000">'Moderately awesome'</span><span style="color: #990000">,</span>
    <span style="color: #990000">])</span>

    <span style="font-style: italic"><span style="color: #9A1900"># She decided to select "very awesome", which is answer #1</span></span>
    chosen <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_css_selector</span></span><span style="color: #990000">(</span>
<span style="font-style: italic"><span style="color: #9A1900">            "input[value='1']"</span></span>
    <span style="color: #990000">)</span>
    chosen<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Elspeth clicks 'submit'</span></span>
    self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_css_selector</span></span><span style="color: #990000">(</span>
<span style="font-style: italic"><span style="color: #9A1900">            "input[type='submit']"</span></span>
    <span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">click</span></span><span style="color: #990000">()</span>

    <span style="font-style: italic"><span style="color: #9A1900"># The page refreshes, and she sees that her choice</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># has updated the results.  They now say</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># "1 vote" and "100%: very awesome".</span></span>
    body <span style="color: #990000">=</span> self<span style="color: #990000">.</span>browser<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">find_element_by_tag_name</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'body'</span><span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">ertNotIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"No-one has voted on this poll yet"</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"1 vote"</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"100%: Very awesome"</span><span style="color: #990000">,</span> body<span style="color: #990000">.</span>text<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Elspeth decides to try to vote again</span></span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">fail</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'second vote'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Shortcut to typing all that in:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>git checkout PYCON_2013_PART_12_FT -- polls/fts/tests.py</code></pre>
</div></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Expected fail:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEquals(len(choice_inputs), 3)
AssertionError: 0 != 3</code></pre>
</div></div>
<div class="sect2">
<h3 id="_unit_testing_template_logic">Unit testing template logic</h3>
<div class="paragraph"><p>Choice inputs can be a bit tricky. Better have a unit test for them. In
<em>polls/tests.py</em>, change the test method in <code>SinglePollViewTest</code>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">SinglePollViewTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_template_rendered_with_poll_and_choice_radio_buttons_and_no_votes</span></span><span style="color: #990000">(</span>
            self
    <span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># set up two polls, to check the right one is displayed</span></span>
        poll1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'6 times 7'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
        poll1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
        poll2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Poll</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'life, the universe and everything'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
        poll2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        <span style="font-style: italic"><span style="color: #9A1900"># add a couple of choices</span></span>
        choice1 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>poll<span style="color: #990000">=</span>poll2<span style="color: #990000">,</span> choice<span style="color: #990000">=</span><span style="color: #FF0000">"42"</span><span style="color: #990000">)</span>
        choice1<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
        choice2 <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Choice</span></span><span style="color: #990000">(</span>poll<span style="color: #990000">=</span>poll2<span style="color: #990000">,</span> choice<span style="color: #990000">=</span><span style="color: #FF0000">"the Spice"</span><span style="color: #990000">)</span>
        choice2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>

        response <span style="color: #990000">=</span> self<span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/poll/%d/'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll2<span style="color: #990000">.</span>id<span style="color: #990000">,</span> <span style="color: #990000">))</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check we've used the poll template</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertTemplateUsed</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span> <span style="color: #FF0000">'poll.html'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check we've passed the right poll into the context</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>context<span style="color: #990000">[</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">],</span> poll2<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check the poll's question appears on the page</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>poll2<span style="color: #990000">.</span>question<span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check our 'no votes yet' message appears</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'No-one has voted on this poll yet'</span><span style="color: #990000">,</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check the choices appear as radio buttons, with the</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># correct 'name' and 'value'</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>
            <span style="color: #FF0000">'&lt;input type="radio" name="vote" value="%d" /&gt;'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>choice1<span style="color: #990000">.</span>id<span style="color: #990000">,),</span>
            response<span style="color: #990000">.</span>content
        <span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>
            <span style="color: #FF0000">'&lt;input type="radio" name="vote" value="%d" /&gt;'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>choice2<span style="color: #990000">.</span>id<span style="color: #990000">,),</span>
            response<span style="color: #990000">.</span>content
        <span style="color: #990000">)</span>
        <span style="font-style: italic"><span style="color: #9A1900"># check there are labels too</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;label&gt;%s'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>choice1<span style="color: #990000">.</span>choice<span style="color: #990000">,),</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'&lt;label&gt;%s'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>choice2<span style="color: #990000">.</span>choice<span style="color: #990000">,),</span> response<span style="color: #990000">.</span>content<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Now the tests drive what we add to the template:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">&lt;h1&gt;</span></span>{{ poll.question }}<span style="font-weight: bold"><span style="color: #0000FF">&lt;/h1&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>No-one has voted on this poll yet<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span>
    {% for choice in poll.choice_set.all %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;li&gt;&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"vote"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"{{ choice.id }}"</span><span style="font-weight: bold"><span style="color: #0000FF">/&gt;&lt;/li&gt;</span></span>
    {% endfor %}
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/ul&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>Gets past the <code>&lt;input&gt;</code> tests:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '&lt;label&gt;42' not found in '&lt;html&gt;\n    &lt;head&gt;\n
&lt;title&gt;life, the universe and everything&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n
&lt;h1&gt;life, the universe and everything&lt;/h1&gt;\n        &lt;p&gt;No-one has voted on this
poll yet&lt;/p&gt;\n        \n            &lt;input type="radio" name="vote" value="1"
/&gt;\n        \n            &lt;input type="radio" name="vote" value="2" /&gt;\n
\n    &lt;/body&gt;\n&lt;/html&gt;\n'</code></pre>
</div></div>
<div class="paragraph"><p>Let&#8217;s add a <code>&lt;label&gt;</code> or two:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    {% for choice in poll.choice_set.all %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;label&gt;</span></span>{{ choice.choice }}
            <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"radio"</span> <span style="color: #009900">name</span><span style="color: #990000">=</span><span style="color: #FF0000">"vote"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"{{ choice.id }}"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;/label&gt;</span></span>
    {% endfor %}</tt></pre></div></div>
<div class="paragraph"><p>And unit tests should now pass.  The FTs want a submit input:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>NoSuchElementException: Message: u'Unable to locate element: {"method":"css selector","selector":"input[type=\'submit\']"}' ;</code></pre>
</div></div>
<div class="paragraph"><p>Now that we&#8217;re asking for a submit button, we should probably have a real form
that sends a POST to a real URL.  Let&#8217;s do that. Maybe in a new test:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_poll_has_vote_form_which_posts_to_correct_url</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        poll <span style="color: #990000">=</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'question'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>

        response <span style="color: #990000">=</span> self<span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/poll/%d/'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll<span style="color: #990000">.</span>id<span style="color: #990000">,</span> <span style="color: #990000">))</span>

        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>
            <span style="color: #FF0000">'&lt;form method="POST" action="/poll/%d/vote"&gt;'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll<span style="color: #990000">.</span>id<span style="color: #990000">,),</span>
            response<span style="color: #990000">.</span>content
        <span style="color: #990000">)</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertIn</span></span><span style="color: #990000">(</span>
            <span style="color: #FF0000">'&lt;input type="submit"'</span><span style="color: #990000">,</span>
            response<span style="color: #990000">.</span>content
        <span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>AssertionError: <em>&lt;form method="POST" action="/poll/1/vote"&gt;</em> not found in <em>&lt;html&gt;\n    &lt;head&gt;\n        &lt;title&gt;question&lt;/title&gt;\n    &lt;/head&gt;\n    &lt;body&gt;\n        &lt;h1&gt;question&lt;/h1&gt;\n        &lt;p&gt;No-one has voted on this poll yet&lt;/p&gt;\n        \n    &lt;/body&gt;\n&lt;/html&gt;\n</em></p></div>
<div class="paragraph"><p>So we fix that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">&lt;p&gt;</span></span>No-one has voted on this poll yet<span style="font-weight: bold"><span style="color: #0000FF">&lt;/p&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"POST"</span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/poll/{{ poll.id }}/vote"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        {% for choice in poll.choice_set.all %}</tt></pre></div></div>
<div class="paragraph"><p>And the next fail is about the input, so we add that:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>        {% endfor %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;input</span></span> <span style="color: #009900">type</span><span style="color: #990000">=</span><span style="color: #FF0000">"submit"</span> <span style="color: #009900">value</span><span style="color: #990000">=</span><span style="color: #FF0000">"Vote"</span> <span style="font-weight: bold"><span style="color: #0000FF">/&gt;</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">&lt;/form&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And now the FT should get to this:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>AssertionError: '1 vote' not found in u'Page not found (404) :-/'</code></pre>
</div></div>
<div class="paragraph"><p>Because we don&#8217;t yet have a URL and view to submit votes to.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced task</div>
<div class="paragraph"><p>Remove any hard-coded references to urls as strings - we should have these
defined in one place only.  Hint: find the <code>reverse</code> function.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_a_new_url_view_for_post_submissions">A new URL + view for POST submissions</h3>
<div class="paragraph"><p>Test the new URL + view with the Django Test Client. In <em>polls/tests.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">SinglePollViewTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>
    <span style="color: #990000">[...]</span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> <span style="font-weight: bold"><span style="color: #000000">PollVoteViewTest</span></span><span style="color: #990000">(</span>TestCase<span style="color: #990000">):</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_can_vote_via_POST</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># set up a poll with choices</span></span>
        poll <span style="color: #990000">=</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>question<span style="color: #990000">=</span><span style="color: #FF0000">'who?'</span><span style="color: #990000">,</span> pub_date<span style="color: #990000">=</span>timezone<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">now</span></span><span style="color: #990000">())</span>
        poll<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
        choice1 <span style="color: #990000">=</span> Choice<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>poll<span style="color: #990000">=</span>poll<span style="color: #990000">,</span> choice<span style="color: #990000">=</span><span style="color: #FF0000">'me'</span><span style="color: #990000">,</span> votes<span style="color: #990000">=</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
        choice2 <span style="color: #990000">=</span> Choice<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">create</span></span><span style="color: #990000">(</span>poll<span style="color: #990000">=</span>poll<span style="color: #990000">,</span> choice<span style="color: #990000">=</span><span style="color: #FF0000">'you'</span><span style="color: #990000">,</span> votes<span style="color: #990000">=</span><span style="color: #993399">3</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># set up our POST data - keys and values are unicode</span></span>
        post_data <span style="color: #990000">=</span> <span style="color: #990000">{</span>u<span style="color: #FF0000">'vote'</span><span style="color: #990000">:</span> <span style="font-weight: bold"><span style="color: #000000">unicode</span></span><span style="color: #990000">(</span>choice2<span style="color: #990000">.</span>id<span style="color: #990000">)}</span>

        <span style="font-style: italic"><span style="color: #9A1900"># make our request to the view</span></span>
        poll_url <span style="color: #990000">=</span> <span style="color: #FF0000">'/poll/%d/vote'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll1<span style="color: #990000">.</span>id<span style="color: #990000">,)</span>
        response <span style="color: #990000">=</span> self<span style="color: #990000">.</span>client<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">post</span></span><span style="color: #990000">(</span>poll_url<span style="color: #990000">,</span> data<span style="color: #990000">=</span>post_data<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check it wasn't a 404</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertNotEqual</span></span><span style="color: #990000">(</span>response<span style="color: #990000">.</span>status_code<span style="color: #990000">,</span> <span style="color: #993399">404</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># retrieve the updated choice from the database</span></span>
        choice_in_db <span style="color: #990000">=</span> Choice<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>pk<span style="color: #990000">=</span>choice2<span style="color: #990000">.</span>id<span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check it's votes have gone up by 1</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertEquals</span></span><span style="color: #990000">(</span>choice_in_db<span style="color: #990000">.</span>votes<span style="color: #990000">,</span> <span style="color: #993399">4</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># "always redirect after a POST". In this case, we go back</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># to the poll page.</span></span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">assertRedirects</span></span><span style="color: #990000">(</span>response<span style="color: #990000">,</span> <span style="color: #FF0000">"/poll/%d/"</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll1<span style="color: #990000">.</span>id<span style="color: #990000">,))</span></tt></pre></div></div>
<div class="paragraph"><p>Gives:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertNotEqual(response.status_code, 404)
AssertionError: 404 == 404</code></pre>
</div></div>
<div class="paragraph"><p>So, in <em>mysite/urls.py</em>:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #000000">url</span></span><span style="color: #990000">(</span>r<span style="color: #FF0000">'^poll/(\d+)/vote$'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'polls.views.vote'</span><span style="color: #990000">,</span> name<span style="color: #990000">=</span><span style="color: #FF0000">'vote'</span><span style="color: #990000">),</span></tt></pre></div></div>
<div class="paragraph"><p>Gives</p></div>
<div class="literalblock">
<div class="content">
<pre><code>ViewDoesNotExist:</code></pre>
</div></div>
<div class="paragraph"><p>So, in <em>polls/views.py</em>, follow normal TDD cycle (I managed 4 steps, can you do
more?) until you get to:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>    self.assertEquals(choice_in_db.votes, 4)
AssertionError: 3 != 4</code></pre>
</div></div>
<div class="paragraph"><p>Now use the POST data:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> polls<span style="color: #990000">.</span>models <span style="font-weight: bold"><span style="color: #000080">import</span></span> Choice<span style="color: #990000">,</span> Poll

<span style="color: #990000">[...]</span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">vote</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> poll_id<span style="color: #990000">):</span>
    poll <span style="color: #990000">=</span> Poll<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">=</span>poll_id<span style="color: #990000">)</span>
    choice <span style="color: #990000">=</span> Choice<span style="color: #990000">.</span>objects<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span>id<span style="color: #990000">=</span>request<span style="color: #990000">.</span>POST<span style="color: #990000">[</span><span style="color: #FF0000">'vote'</span><span style="color: #990000">])</span>
    choice<span style="color: #990000">.</span>votes <span style="color: #990000">+=</span> <span style="color: #993399">1</span>
    choice<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">render</span></span><span style="color: #990000">(</span>request<span style="color: #990000">,</span> <span style="color: #FF0000">'poll.html'</span><span style="color: #990000">,</span> <span style="color: #990000">{</span><span style="color: #FF0000">'poll'</span><span style="color: #990000">:</span> poll<span style="color: #990000">})</span></tt></pre></div></div>
<div class="paragraph"><p>Then:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: Response didn't redirect as expected: Response code was 200
(expected 302)</code></pre>
</div></div>
<div class="paragraph"><p>Finally:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> django<span style="color: #990000">.</span>shortcuts <span style="font-weight: bold"><span style="color: #000080">import</span></span> redirect<span style="color: #990000">,</span> render

<span style="color: #990000">[...]</span>

    choice<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">save</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">redirect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'/poll/%d/'</span> <span style="color: #990000">%</span> <span style="color: #990000">(</span>poll<span style="color: #990000">.</span>id<span style="color: #990000">,))</span></tt></pre></div></div>
<div class="paragraph"><p>Unit tests now pass.  What about the FT?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: '1 vote' not found in u'Forbidden (403)\nCSRF verification
failed. Request aborted.\nMore information is available with DEBUG=True.'</code></pre>
</div></div>
<div class="paragraph"><p>We need to include a CSRF protection tag in our form:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.6
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">&lt;form</span></span> <span style="color: #009900">action</span><span style="color: #990000">=</span><span style="color: #FF0000">"/poll/{{ poll.id }}/vote"</span> <span style="color: #009900">method</span><span style="color: #990000">=</span><span style="color: #FF0000">"POST"</span><span style="font-weight: bold"><span style="color: #0000FF">&gt;</span></span>
        {% csrf_token %}
        <span style="font-weight: bold"><span style="color: #0000FF">&lt;ul&gt;</span></span></tt></pre></div></div>
<div class="paragraph"><p>And now?</p></div>
<div class="listingblock">
<div class="content">
<pre><code>AssertionError: 'No-one has voted on this poll yet' unexpectedly found in u'How
awesome is TDD?\nNo-one has voted on this poll yet\nVery awesome\nQuite
awesome\nModerately awesome'</code></pre>
</div></div>
<div class="paragraph"><p>Next would be printing the votes&#8230; But that&#8217;s up to you!</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Advanced tasks</div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Find out how CSRF protection works
</p>
</li>
<li>
<p>
Look up the docs for the <code>redirect</code> function. What would be a better
solution?
</p>
</li>
</ol></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_end_8230_for_now">THE END&#8230;. for now?</h2>
<div class="sectionbody">
<div class="paragraph"><p>Thanks for coming along!  I hope you enjoyed it, and I hope you found it
useful.</p></div>
<div class="paragraph"><p>Let me have your feedback!  What went well, what could I improve?  Let me
know via <a href="mailto:harry.percival@gmail.com">harry.percival@gmail.com</a></p></div>
<div class="paragraph"><p>This doesn&#8217;t need to be the end of your TDD journey&#8201;&#8212;&#8201;there&#8217;s <strong>loads</strong> more
content in my tutorial, at <a href="http://www.tdd-django-tutorial.com/">http://www.tdd-django-tutorial.com/</a></p></div>
<div class="paragraph"><p>You can find me on Twitter via <strong>@hjwp</strong></p></div>
<div class="paragraph"><p>Finally, watch out for my book, due later this year on O&#8217;Reilly!  It should
be in the Early Release Program by the time PyCon comes around, so check it
out and let me know what you think!</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-03-06 14:23:36 GMT
</div>
</div>
</body>
</html>
